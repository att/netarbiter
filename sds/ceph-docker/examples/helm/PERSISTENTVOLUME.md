# Persistent Volume  
Authors: Hee Won Lee <knowpd@research.att.com>  
Created on 10/27/2017  

References:  
<https://kubernetes.io/docs/concepts/storage/persistent-volumes/#ceph-rbd>  
<https://docs.openshift.org/3.6/install_config/storage_examples/ceph_rbd_dynamic_example.html>

### Storage Class
```
$ kubectl get storageclass general -n ceph -o yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: general
parameters:
  adminId: admin
  adminSecretName: pvc-ceph-conf-combined-storageclass
  adminSecretNamespace: ceph
  imageFeatures: layering
  imageFormat: "2"
  monitors: ceph-mon.ceph:6789
  pool: rbd
  userId: admin
  userSecretName: pvc-ceph-client-key
provisioner: ceph.com/rbd
```

- adminId: Ceph client ID that is capable of creating images in the pool.  
You can find it from:
```
$ kubectl -n ceph exec -it ceph-mon-0 -- cat /etc/ceph/ceph.client.admin.keyring
[client.admin]
  key = AQAXFNpZAAAAABAAoOuDm+mGI/EmK89BNoaeiA==
  auid = 0
  caps mds = "allow"
  caps mon = "allow *"
  caps osd = "allow *"
```

- adminSecret: Secret Name for adminId
```
$ kubectl get secrets pvc-ceph-conf-combined-storageclass -n ceph -o yaml
apiVersion: v1
kind: Secret
metadata:
  name: pvc-ceph-conf-combined-storageclass
  namespace: ceph
data:
  key: QVFBWEZOcFpBQUFBQUJBQW9PdURtK21HSS9FbUs4OUJOb2FlaUE9PQo=
type: kubernetes.io/rbd
```
Note: This key is encoded based on the key of ceph.client.admin.keyring.
```
$ echo "AQAXFNpZAAAAABAAoOuDm+mGI/EmK89BNoaeiA==" |base64 -
QVFBWEZOcFpBQUFBQUJBQW9PdURtK21HSS9FbUs4OUJOb2FlaUE9PQo=
```

- userId: Ceph client ID that is used to map the RBD image. Default is the same as adminId.

```
$ kubectl get secret pvc-ceph-client-key -o yaml
apiVersion: v1
kind: Secret
metadata:
  name: pvc-ceph-client-key
  namespace: default
data:
  key: QVFBWEZOcFpBQUFBQUJBQW9PdURtK21HSS9FbUs4OUJOb2FlaUE9PQo=
type: kubernetes.io/rbd
```
Note: This key is the same as the key of pvc-ceph-conf-combined-storageclass.


### Persistent Volume Claim (PVC)

```
$ kubectl get pvc ceph-test -o yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  annotations:
    volume.beta.kubernetes.io/storage-class: general
    volume.beta.kubernetes.io/storage-provisioner: ceph.com/rbd
  name: ceph-test
  namespace: default
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
  volumeName: pvc-258180a2-aeca-11e7-855a-d4ae52a3acc1
status:
  accessModes:
  - ReadWriteOnce
  capacity:
    storage: 20Gi
  phase: Bound
```

### Persistent Volume (PV)   
This PV is generated by the PVC (`ceph-test`) using the StorageClass (`general`). Hence, you can find some infromation from the PVC and the other from the StorageClass.
```
$ kubectl get pv pvc-258180a2-aeca-11e7-855a-d4ae52a3acc1 -o yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  annotations:
    pv.kubernetes.io/provisioned-by: ceph.com/rbd
    rbdProvisionerIdentity: ceph.com/rbd
  name: pvc-258180a2-aeca-11e7-855a-d4ae52a3acc1
spec:
  accessModes:
  - ReadWriteOnce				# from PVC
  capacity:
    storage: 20Gi				# from PVC
  claimRef:
    apiVersion: v1
    kind: PersistentVolumeClaim
    name: ceph-test				# from PVC
    namespace: default				# from PVC
  persistentVolumeReclaimPolicy: Delete
  storageClassName: general			# from PVC
  rbd:
    image: kubernetes-dynamic-pvc-38cbdd08-aeca-11e7-a613-eea649bc6cd0
    keyring: /etc/ceph/keyring
    monitors:
    - ceph-mon.ceph:6789			# from StorageClass
    pool: rbd					# from StorageClass
    secretRef:
      name: pvc-ceph-client-key			# from StorageClass 
    user: admin					# from StorageClass
status:
  phase: Bound
```
[KEY POINT] **The secret `pvc-ceph-client-key` should be present in a namespace where this PV exists.**

